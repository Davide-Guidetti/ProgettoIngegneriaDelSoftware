<!DOCTYPE html>
<html lang="it">
<head>
	<title>AZUDU</title>
	<meta charset="utf-8">

	<!-- script for usage of bootstrap, with jquery-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

	<style>
	.body {
    margin: 0;
    padding-top: 40px;
    color: #2e323c;
    background: #f5f6fa;
    position: relative;
    height: 100%;
	}
	.account-settings .user-profile {
	    margin: 0 0 1rem 0;
	    padding-bottom: 1rem;
	    text-align: center;
	}
	.account-settings .user-profile .user-avatar {
	    margin: 0 0 1rem 0;
	}
	.account-settings .user-profile .user-avatar img {
	    width: 90px;
	    height: 90px;
	    -webkit-border-radius: 100px;
	    -moz-border-radius: 100px;
	    border-radius: 100px;
	}
	.account-settings .user-profile h5.user-name {
	    margin: 0 0 0.5rem 0;
	}
	.account-settings .user-profile h6.user-email {
	    margin: 0;
	    font-size: 0.8rem;
	    font-weight: 400;
	    color: #9fa8b9;
	}
	.account-settings .about {
	    margin: 2rem 0 0 0;
	    text-align: center;
	}
	.account-settings .about h5 {
	    margin: 0 0 15px 0;
	    color: #007ae1;
	}
	.account-settings .about p {
	    font-size: 0.825rem;
	}
	.form-control {
	    border: 1px solid #cfd1d8;
	    -webkit-border-radius: 2px;
	    -moz-border-radius: 2px;
	    border-radius: 2px;
	    font-size: .825rem;
	    background: #ffffff;
	    color: #2e323c;
	}
	
	.card {
	    background: #ffffff;
	    -webkit-border-radius: 5px;
	    -moz-border-radius: 5px;
	    border-radius: 5px;
	    border: 0;
	    margin-bottom: 1rem;
	}

	</style>

	<script>

	//il seguente codice di jquery è in grado di tenere traccia di tutte le checkbox selezionate nella pagina con il valore associato
	var checkedCompetenze = [];

	function getCompetenze(){
		checkedCompetenze = [];
		$('#competenze input').each(function(i, item){
	 		if($(this).is(':checked')){
	    		checkedCompetenze.push($(this).attr("name"));
	    	}
		});
		console.log("checkedCompetenze:", checkedCompetenze);
	}
	

	function inviaAjaxCompetenze(){
		console.log("invio competenze iniziali");
		$.ajax({
			url: "/MyTemplate/servletcontroller", //server per richiedere la lista di competenze presenti
			type: 'post',
			data: {
				email: "giorgio.mocci@studio.unibo.it"
			},
			success: function(Obj){
				//mockup test
				//Obj="[ { \"nomeCompetenza\": \"Guidatore ambulanza\", \"checked\":\"true\" }, {\"nomeCompetenza\": \"Sorveglianza pubblica\", \"checked\":\"false\" }, { \"nomeCompetenza\": \"Vigile del fuoco\", \"checked\":\"true\" } ]";
				Obj = JSON.parse(Obj);
				console.log(Obj);
				//nome oggetto competenza contenente il parametro nome
				testo="<form>";
				for ( var a=0, b=Obj.length;  a<b;  a++ ) {
					testo += "<div class=\"custom-control custom-checkbox mb-3\">";
					if (Obj[a].checked=="true"){
						testo += "<input type=\"checkbox\" class=\"custom-control-input\" id=\"customCheck"+a+"\" name=\""+Obj[a].nomeCompetenza+"\" checked>";
					}else{
						testo += "<input type=\"checkbox\" class=\"custom-control-input\" id=\"customCheck"+a+"\" name=\""+Obj[a].nomeCompetenza+"\">";
					}
					testo += "<label class=\"custom-control-label\" for=\"customCheck"+a+"\">"+Obj[a].nomeCompetenza+"</label>";
					testo += "</div>";
				}

				testo+="</form>";
				document.getElementById("competenze").innerHTML=testo;
			}
		});
		
		//getComitati
		$.ajax({
			url: "/MyTemplate/servletcontroller", //server per richiedere la lista di competenze presenti
			async: false, //non rende asincrona la richiesta, in questo modo si caricano correttamente le competenze
			type: 'post',
			data: {
				getComitati: true,
				email: "giorgio.mocci@studio.unibo.it"
			},
			success: function(Obj){
				console.log(Obj);
				Obj = JSON.parse(Obj);
				
				testo="<select class=\"custom-select\" id=\"comitato\"><option selected>"+Obj[0]+"</option>";
				
				  
				for(var i = 1; i < Object.keys(Obj).length; i += 1){
					testo+="<option value=\""+Obj[i]+"\">"+Obj[i]+"</option>";
				}
				testo+="</select>"
				
				$("#comitatiSelezionabili").html(testo);

			}
		});
		
		var comitato=$("#comitato").val();
		console.log("comitato d'appartenenza "+comitato+".");
		$.ajax({
			url: '/MyTemplate/servletcontroller', //server per effettuare la query dei volontari in base alle competenze
			type: 'post',
			data: {
				email: "giorgio.mocci@studio.unibo.it",
				isApprove: comitato
			},
			success: function (Obj) {
				console.log("isApprove "+Obj.split(",")[0]+" "+Obj.split(",")[1]);
				if (Obj.split(",")[0] == "true"){
					document.getElementById("isApproveComitato").innerHTML="Approvato nel comitato";						
					$("#isApproveComitato").css({'color':'green'});
					if (Obj.split(",")[1] == "false"){ //non è coordinatore
						$("#collapsibleNavbar").html("<ul class=\"navbar-nav\"><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Piani compatibili</a></li></ul><ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");
						document.getElementById("role").innerHTML="<br><h5 class=\"mb-2 text-primary\">Ruolo</h5><h5 class=\"user-name\">Volontario</h5>";
					}else{ //è un coordinatore
						$("#collapsibleNavbar").html("<ul class=\"navbar-nav\"><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Pannello gestione piani</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/approvaVolontari.html\">Gestione volontari comitato</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Piani compatibili</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/listaVolontari.html\">Lista volontari</a></li></ul><ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");								
						console.log("ruolo coordinatore");
						document.getElementById("role").innerHTML="<br><h5 class=\"mb-2 text-primary\">Ruolo</h5><h5 class=\"user-name\">Coordinatore</h5>";
					}
				}
				else{ //non è approvato
					if (comitato==""){
						document.getElementById("isApproveComitato").innerHTML="Non appartenente a nessun comitato";
					}else{
						document.getElementById("isApproveComitato").innerHTML="Non approvato nel comitato";						
					}
					document.getElementById("role").innerHTML="";
					$("#isApproveComitato").css({'color':'red'});
					$("#collapsibleNavbar").html("<ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");
				}
			}
		});
		
	}

	function invio(){
		console.log("invio informazioni aggiornate");

		getCompetenze();
		
		//check inserimento corretto numbero
		var numb=$("#phoneNumber").val();
		var matcher= new RegExp("[0-9]{3}[0-9]{3}[0-9]{4}");
		var foundNumber = matcher.test(numb);
		console.log("found: "+foundNumber);
		console.log("numbero telefono "+ numb);
		
		var nuovaPwd=$("#nuovaPwd").val();
		var nuovaPwdDue=$("#nuovaPwdDue").val();
		
		if (nuovaPwd != nuovaPwdDue){
			document.getElementById("successDisplay").innerHTML="";
			document.getElementById("errorDisplay").innerHTML="Errore inserimento password";
		}
		else{
			if (foundNumber== true){
				$.ajax({
					url: '/MyTemplate/servletcontroller', //server per effettuare la query dei volontari in base alle competenze
					type: 'post',
					data: {
						listCompetenze: JSON.stringify(checkedCompetenze),
						email: "giorgio.mocci@studio.unibo.it",
						phone: numb
					},
					success: function (Obj) {
							console.log("inviato competenze aggiornate ");
							console.log("inviato numero di telefono");
							document.getElementById("successDisplay").innerHTML="Aggiornamento profilo avvenuto correttamente";
							document.getElementById("errorDisplay").innerHTML="";
					}
				});
			}
			else
			{
				$.ajax({
					url: '/MyTemplate/servletcontroller', //server per effettuare la query dei volontari in base alle competenze
					type: 'post',
					data: {
						listCompetenze: JSON.stringify(checkedCompetenze),
						email: "giorgio.mocci@studio.unibo.it"
					},
					success: function (Obj) {
							console.log("inviato competenze aggiornate ");
							document.getElementById("successDisplay").innerHTML="Aggiornamento profilo avvenuto correttamente";
							document.getElementById("errorDisplay").innerHTML="";
					}
				});
			}
	
			var comitato=$("#comitato").val();
			console.log("comitato d'appartenenza "+comitato);
			$.ajax({
				url: '/MyTemplate/servletcontroller', //server per effettuare la query dei volontari in base alle competenze
				type: 'post',
				data: {
					email: "giorgio.mocci@studio.unibo.it",
					isApprove: comitato
				},
				success: function (Obj) {
					console.log("isApprove "+Obj.split(",")[0]+" "+Obj.split(",")[1]);
					if (Obj.split(",")[0] == "true"){
						document.getElementById("isApproveComitato").innerHTML="Approvato nel comitato";						
						$("#isApproveComitato").css({'color':'green'});
						if (Obj.split(",")[1] == "false"){ //non è coordinatore
							$("#collapsibleNavbar").html("<ul class=\"navbar-nav\"><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Piani compatibili</a></li></ul><ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");
							document.getElementById("role").innerHTML="<br><h5 class=\"mb-2 text-primary\">Ruolo</h5><h5 class=\"user-name\">Volontario</h5>";
						}else{ //è un coordinatore
							$("#collapsibleNavbar").html("<ul class=\"navbar-nav\"><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Piani compatibili</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/approvaVolontari.html\">Gestione volontari comitato</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/gestionePiani.html\">Piani compatibili</a></li><li class=\"nav-item\"><a class=\"nav-link\" href=\"http://localhost:8080/MyTemplate/pages/azudo/listaVolontari.html\">Lista volontari</a></li></ul><ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");								
							console.log("ruolo coordinatore");
							document.getElementById("role").innerHTML="<br><h5 class=\"mb-2 text-primary\">Ruolo</h5><h5 class=\"user-name\">Coordinatore</h5>";
						}
					}
					else{ //non è approvato
						if (comitato==""){
							document.getElementById("isApproveComitato").innerHTML="Non appartenente a nessun comitato";
						}else{
							document.getElementById("isApproveComitato").innerHTML="Non approvato nel comitato";						
						}
						document.getElementById("role").innerHTML="";
						$("#isApproveComitato").css({'color':'red'});
						$("#collapsibleNavbar").html("<ul class=\"navbar-nav ml-auto\"><li class=\"nav-item\"><a class=\"navbar-brand\">Profilo</a></li></ul>");
					}
				}
			});
		}
	}

	</script>

</head>
<body onload="inviaAjaxCompetenze()">
	<!-- Title -->
	<div class="jumbotron text-center" style="margin-bottom:0">
		<h1>AZUDU</h1>
		<!--<p></p> -->
	</div>

	<!-- navbar-->
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">

		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
		<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="collapsibleNavbar"></div>
	</nav>
	<br>

	<form id="DataManagement" class="container" style="margin-top:30px" >
		<br>

    <div class="container">
	<div class="row gutters">
	<div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
	<div class="card h-100">
		<div class="card-body">
			<div class="account-settings">
				<div class="user-profile">
					<img style = "position:relative; right:22px;" src="../../images/Azudu.png" alt="Logo" >
					<br><br>
					<h5 class="user-name">    Giorgio Mocci</h5>
					<h6 class="user-email">   giorgio.mocci@studio.unibo.it</h6>
					
					<div id="role"></div>
				</div>
	
			</div>
		</div>
	</div>
	</div>
	<div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
	<div class="card h-100">
		<div class="card-body">
			<div class="row gutters">
				<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
					<h6 class="mb-2 text-primary">Modifica Dettagli Personali</h6>
				</div>
	
				<div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
					<div class="form-group">
						<label for="phone">Telefono</label>
						<input type="tel" class="form-control" id="phoneNumber" placeholder="1234567890">
					</div>
				</div>
				<div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
					<div class="form-group">
						<label for="website">Comitato di appartenenza</label>
						<!--	<input type="url" class="form-control" id="website" placeholder="Bologna"> -->
						<div class="dropdown" id="comitatiSelezionabili">
						  
						</div>
						
						<div id="isApproveComitato"></div>
					</div>
				</div>
			</div>
	
	
	
	
	
			<div class="row gutters">
				<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
					<h6 class="mt-3 mb-2 text-primary">Competenze</h6>
					<div id="competenze"></div>
				</div>
	
	
	
			</div>
	
	    <div class="row gutters">
	      <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
	        <h6 class="mt-3 mb-2 text-primary">Modifica Password</h6>
	      </div>
	      <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
	        <div class="form-group">
	          <label for="Street">Nuova password</label>
	         	<input type="password" class="form-control" id="nuovaPwd"  placeholder="nuova password">
	        </div>
	      </div>
	      <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12">
	        <div class="form-group">
	          <label for="Street">Conferma nuova password</label>
	          <input type="password" class="form-control" id="nuovaPwdDue" placeholder="Conferma password">
	        </div>
	      </div>
	
			<div class="row gutters">
				<div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
					<div class="text-right">
	         			 <br><br>
						<button type="button" id="submit" name="submit" class="btn btn-secondary">Cancella</button>
						<button type="button" id="submit" name="submit" class="btn btn-primary"  onclick="invio()">Applica</button>
					</div>
				</div>
			</div>
				<br>
					<p id="successDisplay" style="color:green;"></p>
					<p id="errorDisplay" style="color:red;"></p>
		</div>
	</div>
</div>
</div>
</div>
</div>

	</form>

</body>
</html>
